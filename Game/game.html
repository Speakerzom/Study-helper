<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Game Há»c Táº­p â€“ Study Helper</title>
  <link rel="stylesheet" href="game.css"/>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: Lá»–I (thiáº¿u dá»¯ liá»‡u Ä‘áº§u vÃ o)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-error" class="screen hidden">
  <div class="error-card">
    <div class="err-icon">âš ï¸</div>
    <h2>Thiáº¿u dá»¯ liá»‡u bÃ i há»c</h2>
    <p id="error-msg">Vui lÃ²ng chá»n bÃ i tá»« module Luyá»‡n táº­p trÆ°á»›c khi vÃ o game.</p>
    <a class="btn-back-practice" href="../Practice/practice.html">
      â† Quay vá» Luyá»‡n táº­p
    </a>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: PREPLASH VIDEO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-preplash" class="screen hidden">
  <video id="preplash-video" playsinline muted preload="auto">
    <source src="assets/preplash/preplash.mp4" type="video/mp4"/>
  </video>
  <div id="preplash-overlay">
    <div id="preplash-info">
      <div id="preplash-title"></div>
      <div id="preplash-sub"></div>
    </div>
    <div id="preplash-skip">Nháº¥n Ä‘á»ƒ bá» qua â–¶</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: MÃ€N CHÆ I CHÃNH (1 mÃ n duy nháº¥t)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-game" class="screen hidden">

  <!-- HUD -->
  <div id="hud">
    <div id="hud-left">
      <a class="hud-back" href="../Practice/practice.html" title="Vá» Luyá»‡n táº­p">â†</a>

      <!-- VOLUME CONTROL -->
      <div id="vol-ctrl">
        <button id="vol-btn" title="Ã‚m lÆ°á»£ng">ğŸ”Š</button>
        <div id="vol-panel">
          <div class="vol-row">
            <span class="vol-lbl">ğŸµ</span>
            <input type="range" id="vol-music" min="0" max="100" value="40" title="Nháº¡c ná»n">
            <span class="vol-val" id="val-music">40</span>
          </div>
          <div class="vol-row">
            <span class="vol-lbl">ğŸ”Š</span>
            <input type="range" id="vol-sfx" min="0" max="100" value="70" title="Hiá»‡u á»©ng">
            <span class="vol-val" id="val-sfx">70</span>
          </div>
        </div>
      </div>

      <div id="hud-lesson-name"></div>
    </div>
    <div id="hud-center">
      <span id="phase-badge" class="phase-normal">âš¡ NORMAL</span>
    </div>
    <div id="hud-right">
      <span class="energy-lbl">âš¡</span>
      <div id="energy-bar-bg">
        <div id="energy-bar-fill"></div>
      </div>
      <span id="energy-text">0/0</span>
    </div>
  </div>

  <!-- CANVAS: ná»n game + nhÃ¢n váº­t -->
  <canvas id="game-canvas"></canvas>

  <!-- BOSS TIMER (chá»‰ hiá»‡n á»Ÿ phase boss) -->
  <div id="boss-timer" class="hidden">
    <svg id="timer-svg" viewBox="0 0 60 60">
      <circle cx="30" cy="30" r="26" class="t-bg"/>
      <circle cx="30" cy="30" r="26" class="t-ring" id="t-ring"/>
    </svg>
    <span id="timer-num">60</span>
  </div>

  <!-- NÃšT TIáº¾N (normal phase) -->
  <button id="btn-advance">âš”ï¸ Tiáº¿n</button>

  <!-- ATTACK FLASH OVERLAY -->
  <div id="attack-flash" class="hidden"></div>

  <!-- KHUNG CÃ‚U Há»I -->
  <div id="question-panel" class="hidden">

    <div id="q-frame">
      <span id="q-badge">4 lá»±a chá»n</span>
      <p id="q-text"></p>
    </div>

    <div id="a-frame">
      <div id="a-body">
        <!-- inject by game.js -->
      </div>
    </div>

    <!-- Explanation (hiá»‡n sau khi tráº£ lá»i) -->
    <div id="q-explanation" class="hidden">
      <span id="expl-icon">âœ…</span>
      <span id="expl-text"></span>
    </div>

  </div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: THUA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-lose" class="screen hidden">
  <div class="end-bg-img" id="lose-bg"></div>
  <div class="end-card">
    <div class="end-icon">ğŸ’€</div>
    <h2 class="end-title lose-title">Tháº¥t báº¡i!</h2>
    <p class="end-sub">NÄƒng lÆ°á»£ng Ä‘Ã£ cáº¡n kiá»‡t. HÃ£y cá»‘ gáº¯ng hÆ¡n!</p>
    <div class="end-stats" id="lose-stats"></div>
    <div class="end-btns">
      <button class="btn-end btn-retry" id="btn-retry">ğŸ”„ ChÆ¡i láº¡i</button>
      <a class="btn-end btn-to-practice" id="btn-lose-back" href="../Theory/theory.html">ğŸ“– LÃ½ thuyáº¿t</a>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: THáº®NG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-win" class="screen hidden">
  <div class="end-bg-img" id="win-bg"></div>
  <div class="end-card">
    <div class="end-icon">ğŸ†</div>
    <h2 class="end-title win-title">Chiáº¿n tháº¯ng!</h2>
    <p class="end-sub">Báº¡n Ä‘Ã£ Ä‘Ã¡nh báº¡i Boss! Xuáº¥t sáº¯c!</p>
    <div class="end-stats" id="win-stats"></div>
    <div class="end-btns">
      <button class="btn-end btn-complete" id="btn-complete">âœ… HoÃ n thÃ nh</button>
      <button class="btn-end btn-retry-win" id="btn-retry-win">ğŸ”„ ChÆ¡i láº¡i</button>
    </div>
  </div>
</div>

<script src="game.js"></script>
<script>
  /* Gáº¯n URL cÃ³ params cho nÃºt quay vá» Practice sau khi game.js cháº¡y xong */
  /* â”€â”€ VOLUME CONTROL â”€â”€ */
  (function initVolume() {
    const btn      = document.getElementById('vol-btn');
    const panel    = document.getElementById('vol-panel');
    const slMusic  = document.getElementById('vol-music');
    const slSfx    = document.getElementById('vol-sfx');
    const valMusic = document.getElementById('val-music');
    const valSfx   = document.getElementById('val-sfx');

    /* Äá»c giÃ¡ trá»‹ tá»« localStorage */
    const _sm = localStorage.getItem('sh_vol_music');
    const _ss = localStorage.getItem('sh_vol_sfx');
    const savedMusic = (_sm !== null && !isNaN(Number(_sm))) ? Number(_sm) : 40;
    const savedSfx   = (_ss !== null && !isNaN(Number(_ss))) ? Number(_ss) : 70;
    slMusic.value = savedMusic; valMusic.textContent = savedMusic;
    slSfx.value   = savedSfx;   valSfx.textContent   = savedSfx;

    function updateIcon() {
      const avg = (Number(slMusic.value) + Number(slSfx.value)) / 200;
      btn.textContent = avg <= 0 ? 'ğŸ”‡' : avg < 0.4 ? 'ğŸ”‰' : 'ğŸ”Š';
    }
    updateIcon();

    /* Gáº¯n event TRÆ¯á»šC TIÃŠN â€” khÃ´ng phá»¥ thuá»™c AUDIO */
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (panel.classList.contains('open')) {
        panel.classList.remove('open');
      } else {
        const r = btn.getBoundingClientRect();
        panel.style.top  = (r.bottom + 8) + 'px';
        panel.style.left = r.left + 'px';
        panel.classList.add('open');
      }
    });

    document.addEventListener('click', function(e) {
      if (!btn.contains(e.target) && !panel.contains(e.target))
        panel.classList.remove('open');
    });

    slMusic.addEventListener('input', function() {
      const v = Number(slMusic.value);
      valMusic.textContent = v;
      localStorage.setItem('sh_vol_music', v);
      updateIcon();
      try { if (typeof AUDIO !== 'undefined') AUDIO.setMusicVol(v / 100); } catch(_) {}
    });

    slSfx.addEventListener('input', function() {
      const v = Number(slSfx.value);
      valSfx.textContent = v;
      localStorage.setItem('sh_vol_sfx', v);
      updateIcon();
      try { if (typeof AUDIO !== 'undefined') AUDIO.setSfxVol(v / 100); } catch(_) {}
    });
  })();

  (function patchBackLinks() {
    const p = new URLSearchParams(location.search);
    const cls  = p.get('class')   || '';
    const subj = p.get('subject') || '';
    const les  = p.get('lesson')  || '';
    const base = '../Practice/practice.html';
    const url  = `${base}?class=${encodeURIComponent(cls)}&subject=${encodeURIComponent(subj)}&lesson=${encodeURIComponent(les)}`;

    /* NÃºt "LÃ½ thuyáº¿t" trong screen-lose â†’ vá» Theory Ä‘Ãºng mÃ´n */
    const theoryUrl = `../Theory/theory.html?class=${encodeURIComponent(cls)}&subject=${encodeURIComponent(subj)}`;
    const loseBack = document.getElementById('btn-lose-back');
    if (loseBack) {
      loseBack.removeAttribute('href');
      loseBack.style.cursor = 'pointer';
      loseBack.addEventListener('click', () => {
        try { AUDIO?.playSFX('button'); } catch(_) {}
        try { AUDIO?.stopMusic(); } catch(_) {}
        setTimeout(() => { window.location.href = theoryUrl; }, 200);
      });
    }

    /* NÃºt Back trong HUD (nÃºt â† á»Ÿ gÃ³c trÃ¡i) */
    const hudBack = document.querySelector('.hud-back');
    if (hudBack) {
      hudBack.removeAttribute('href');
      hudBack.style.cursor = 'pointer';
      hudBack.addEventListener('click', () => {
        try { AUDIO?.playSFX('button'); } catch(_) {}
        try { AUDIO?.stopMusic(); } catch(_) {}
        setTimeout(() => { window.location.href = url; }, 200);
      });
    }
  })();
</script>
</body>
</html>
