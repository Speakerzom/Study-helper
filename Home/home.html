<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Study Helper</title>
  <style>
    /* ============================================================
       home.css ‚Äì Study Helper
       H·ªá m√†u: cam #FF6B00, tr·∫Øng #FFF, ƒëen #0D0D0D,
               lime #7FFF00, v√†ng #FFD700, cyan #00CED1, teal #00897B
    ============================================================ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --orange : #FF6B00;
      --lime   : #7FFF00;
      --yellow : #FFD700;
      --cyan   : #00CED1;
      --teal   : #00897B;
      --white  : #FFFFFF;
      --black  : #0D0D0D;
      --bg     : #FFFFFF;
      --bg2    : #F5F5F5;
      --surface: #FFFFFF;
      --text   : #0D0D0D;
      --text2  : #444444;
      --border : #E0E0E0;
      --sidebar-w: 260px;
      --header-h : 64px;
      --radius : 12px;
      --shadow : 0 4px 24px rgba(0,0,0,.10);
      --trans  : .3s cubic-bezier(.4,0,.2,1);
    }
    body.dark {
      --bg     : #0D0D0D; --bg2    : #141414;
      --surface: #1A1A1A; --text   : #FFFFFF;
      --text2  : #AAAAAA; --border : #2A2A2A;
      --shadow : 0 4px 24px rgba(0,0,0,.5);
    }
    html, body {
      height: 100%;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg); color: var(--text);
      transition: background var(--trans), color var(--trans);
    }

    /* HEADER */
    header {
      position: fixed; top: 0; left: 0; right: 0;
      height: var(--header-h);
      background: var(--surface);
      border-bottom: 2px solid var(--orange);
      display: flex; align-items: center;
      padding: 0 24px; gap: 18px; z-index: 900;
      box-shadow: var(--shadow);
      transition: background var(--trans);
    }
    #btn-menu {
      background: none; border: 2px solid var(--orange);
      border-radius: 8px; width: 42px; height: 42px;
      cursor: pointer; display: flex; flex-direction: column;
      justify-content: center; align-items: center; gap: 5px;
      flex-shrink: 0; transition: background var(--trans);
    }
    #btn-menu:hover { background: rgba(255,107,0,.12); }
    #btn-menu span {
      display: block; width: 22px; height: 2.5px;
      background: var(--orange); border-radius: 2px;
      transition: transform var(--trans), opacity var(--trans);
    }
    body.sidebar-open #btn-menu span:nth-child(1) { transform: translateY(7.5px) rotate(45deg); }
    body.sidebar-open #btn-menu span:nth-child(2) { opacity: 0; }
    body.sidebar-open #btn-menu span:nth-child(3) { transform: translateY(-7.5px) rotate(-45deg); }

    #logo {
      font-size: 2rem; font-weight: 900; letter-spacing: -1px;
      background: linear-gradient(90deg, var(--cyan) 0%, var(--lime) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; user-select: none; line-height: 1;
    }
    #active-badge {
      margin-left: auto; font-size: .78rem; font-weight: 700;
      letter-spacing: .05em; text-transform: uppercase;
      padding: 4px 12px; border-radius: 20px;
      background: var(--orange); color: #fff;
      transition: background var(--trans);
    }

    /* OVERLAY */
    #overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.45); z-index: 950;
      opacity: 0; pointer-events: none;
      transition: opacity var(--trans);
    }
    body.sidebar-open #overlay { opacity: 1; pointer-events: all; }

    /* SIDEBAR */
    #sidebar {
      position: fixed; top: 0; left: 0;
      width: var(--sidebar-w); height: 100%;
      background: var(--surface);
      border-right: 2px solid var(--orange);
      z-index: 1000; display: flex; flex-direction: column;
      transform: translateX(calc(-1 * var(--sidebar-w)));
      transition: transform var(--trans), background var(--trans);
      box-shadow: 4px 0 32px rgba(0,0,0,.18);
    }
    body.sidebar-open #sidebar { transform: translateX(0); }

    .sidebar-header {
      height: var(--header-h);
      display: flex; align-items: center;
      padding: 0 20px; border-bottom: 1px solid var(--border);
      font-size: .8rem; font-weight: 700;
      letter-spacing: .12em; text-transform: uppercase;
      color: var(--cyan);
    }
    nav#sidebar-nav {
      flex: 1; padding: 16px 12px;
      display: flex; flex-direction: column; gap: 6px;
      overflow-y: auto;
    }
    nav#sidebar-nav a {
      display: flex; align-items: center; gap: 14px;
      padding: 13px 16px; border-radius: var(--radius);
      text-decoration: none; color: var(--text);
      font-size: .97rem; font-weight: 600;
      transition: background var(--trans), color var(--trans), transform .15s;
      cursor: pointer; border: 2px solid transparent;
    }
    nav#sidebar-nav a .nav-icon { font-size: 1.3rem; width: 28px; text-align: center; flex-shrink: 0; }
    nav#sidebar-nav a:hover { background: rgba(255,107,0,.1); border-color: var(--orange); color: var(--orange); transform: translateX(4px); }
    nav#sidebar-nav a.active { background: linear-gradient(90deg,rgba(0,206,209,.18),rgba(127,255,0,.12)); border-color: var(--cyan); color: var(--cyan); }
    nav#sidebar-nav a.active .nav-icon { color: var(--lime); }
    .nav-divider { height: 1px; background: var(--border); margin: 8px 4px; }

    .sidebar-footer { padding: 16px 16px 24px; border-top: 1px solid var(--border); }
    #btn-theme {
      width: 100%; display: flex; align-items: center;
      justify-content: space-between; padding: 11px 16px;
      border-radius: var(--radius); border: 2px solid var(--border);
      background: var(--bg2); color: var(--text);
      font-size: .92rem; font-weight: 600; cursor: pointer;
      transition: border-color var(--trans), background var(--trans); gap: 10px;
    }
    #btn-theme:hover { border-color: var(--cyan); }
    .toggle-track {
      width: 44px; height: 24px; border-radius: 12px;
      background: var(--border); position: relative; flex-shrink: 0;
      transition: background var(--trans);
    }
    body.dark .toggle-track { background: var(--cyan); }
    .toggle-thumb {
      position: absolute; top: 3px; left: 3px;
      width: 18px; height: 18px; border-radius: 50%;
      background: #fff; transition: transform var(--trans);
      box-shadow: 0 1px 4px rgba(0,0,0,.3);
    }
    body.dark .toggle-thumb { transform: translateX(20px); }

    /* MAIN ‚Äî iframe wrapper */
    #main {
      margin-top: var(--header-h);
      height: calc(100vh - var(--header-h));
      background: var(--bg);
      transition: background var(--trans);
      position: relative;
    }

    /* [S·ª¨A] D√πng iframe ƒë·ªÉ load module th·∫≠t, kh√¥ng inject template */
    #module-frame {
      width: 100%; height: 100%;
      border: none; display: block;
    }

    /* Fallback n·∫øu iframe kh√¥ng load */
    #frame-error {
      display: none;
      padding: 40px; text-align: center; color: var(--text2);
      font-size: 1rem;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       AI CHAT WIDGET
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    #ai-widget {
      position: fixed;
      bottom: 28px; right: 28px;
      z-index: 1100;
      display: flex; flex-direction: column; align-items: flex-end;
      gap: 12px;
    }

    /* N√∫t m·ªü/ƒë√≥ng */
    #ai-toggle {
      width: 58px; height: 58px; border-radius: 50%;
      border: 2.5px solid var(--cyan);
      background: var(--surface);
      cursor: pointer; padding: 0; overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,206,209,.35), 0 2px 8px rgba(0,0,0,.2);
      transition: transform .2s, box-shadow .2s, border-color .2s;
      flex-shrink: 0;
    }
    #ai-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 28px rgba(0,206,209,.55), 0 0 0 4px rgba(0,206,209,.15);
    }
    #ai-toggle img {
      width: 100%; height: 100%;
      object-fit: cover; display: block;
    }
    /* Pulse khi ch∆∞a m·ªü */
    #ai-widget:not(.open) #ai-toggle::after {
      content: '';
      position: absolute;
      width: 58px; height: 58px;
      border-radius: 50%;
      border: 2px solid var(--cyan);
      animation: ai-pulse 2s ease-out infinite;
      pointer-events: none;
    }
    @keyframes ai-pulse {
      0%   { transform: scale(1);   opacity: .7; }
      100% { transform: scale(1.7); opacity: 0; }
    }

    /* Badge tr·∫°ng th√°i online */
    #ai-toggle .ai-status {
      position: absolute; bottom: 3px; right: 3px;
      width: 13px; height: 13px; border-radius: 50%;
      background: var(--lime);
      border: 2px solid var(--surface);
      box-shadow: 0 0 6px rgba(127,255,0,.6);
    }

    /* Wrapper toggle ƒë·ªÉ position badge */
    #ai-toggle-wrap {
      position: relative; flex-shrink: 0;
    }

    /* C·ª≠a s·ªï chat */
    #ai-chatbox {
      width: 360px;
      max-height: 520px;
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: 18px;
      display: flex; flex-direction: column;
      overflow: hidden;
      box-shadow: 0 12px 48px rgba(0,0,0,.22), 0 0 0 1px rgba(0,206,209,.1);
      transform-origin: bottom right;
      transition: transform .25s cubic-bezier(.34,1.4,.64,1), opacity .2s;
    }
    #ai-chatbox.hidden {
      transform: scale(.85) translateY(12px);
      opacity: 0;
      pointer-events: none;
    }

    /* Header chat */
    #ai-chat-header {
      display: flex; align-items: center; gap: 10px;
      padding: 13px 16px;
      background: linear-gradient(135deg, rgba(0,206,209,.15), rgba(127,255,0,.08));
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    #ai-chat-header img {
      width: 34px; height: 34px; border-radius: 50%;
      border: 2px solid var(--cyan);
      object-fit: cover; flex-shrink: 0;
    }
    .ai-header-info { flex: 1; min-width: 0; }
    .ai-name {
      font-size: .9rem; font-weight: 800;
      background: linear-gradient(90deg, var(--cyan), var(--lime));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .ai-status-text { font-size: .72rem; color: var(--lime); display: flex; align-items: center; gap: 4px; }
    .ai-status-text::before {
      content: ''; display: inline-block;
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--lime);
      box-shadow: 0 0 5px var(--lime);
      flex-shrink: 0;
    }
    #ai-btn-close {
      background: none; border: none; cursor: pointer;
      color: var(--text2); font-size: 1.2rem; line-height: 1;
      padding: 4px; border-radius: 6px;
      transition: color .15s, background .15s;
    }
    #ai-btn-close:hover { color: var(--text); background: rgba(255,255,255,.1); }

    /* Messages area */
    #ai-messages {
      flex: 1; overflow-y: auto;
      padding: 14px 14px 8px;
      display: flex; flex-direction: column; gap: 10px;
      scroll-behavior: smooth;
    }
    #ai-messages::-webkit-scrollbar { width: 4px; }
    #ai-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .ai-msg {
      max-width: 85%; display: flex; flex-direction: column; gap: 3px;
      animation: msg-in .25s cubic-bezier(.34,1.3,.64,1);
    }
    @keyframes msg-in {
      from { opacity: 0; transform: translateY(8px) scale(.97); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }
    .ai-msg.bot  { align-self: flex-start; }
    .ai-msg.user { align-self: flex-end; }

    .ai-bubble {
      padding: 9px 13px;
      border-radius: 14px;
      font-size: .88rem; line-height: 1.65;
      word-break: break-word;
    }
    .ai-msg.bot  .ai-bubble {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
      color: var(--text);
    }
    .ai-msg.user .ai-bubble {
      background: linear-gradient(135deg, var(--cyan), var(--teal));
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .ai-bubble pre {
      font-family: 'Courier New', monospace;
      font-size: .8rem; white-space: pre-wrap;
      margin-top: 6px;
      background: rgba(0,0,0,.15);
      padding: 8px 10px; border-radius: 8px;
    }

    /* Typing indicator */
    .ai-typing .ai-bubble {
      display: flex; align-items: center; gap: 5px;
      padding: 12px 14px;
    }
    .ai-typing .dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--cyan);
      animation: dot-bounce .9s ease-in-out infinite;
    }
    .ai-typing .dot:nth-child(2) { animation-delay: .15s; }
    .ai-typing .dot:nth-child(3) { animation-delay: .3s; }
    @keyframes dot-bounce {
      0%,80%,100% { transform: translateY(0); opacity: .5; }
      40%          { transform: translateY(-6px); opacity: 1; }
    }

    /* Input area */
    #ai-input-area {
      display: flex; align-items: flex-end; gap: 8px;
      padding: 10px 12px 12px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }
    #ai-input {
      flex: 1;
      resize: none; overflow: hidden;
      min-height: 38px; max-height: 100px;
      padding: 9px 12px;
      border: 1.5px solid var(--border);
      border-radius: 12px;
      background: var(--bg2);
      color: var(--text);
      font-size: .88rem; font-family: inherit;
      line-height: 1.5;
      transition: border-color .2s, box-shadow .2s;
    }
    #ai-input:focus {
      outline: none;
      border-color: var(--cyan);
      box-shadow: 0 0 0 3px rgba(0,206,209,.12);
    }
    #ai-input::placeholder { color: var(--text2); }
    #ai-send {
      width: 38px; height: 38px; border-radius: 50%; border: none;
      background: linear-gradient(135deg, var(--cyan), var(--teal));
      color: #fff; font-size: 1rem; cursor: pointer; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      transition: transform .15s, box-shadow .15s, opacity .15s;
      box-shadow: 0 3px 10px rgba(0,206,209,.4);
    }
    #ai-send:hover:not(:disabled) {
      transform: scale(1.1);
      box-shadow: 0 5px 16px rgba(0,206,209,.55);
    }
    #ai-send:disabled { opacity: .4; cursor: default; transform: none; }

    /* L·ªói API key */
    #ai-api-warn {
      margin: 0 14px 10px;
      padding: 9px 12px;
      background: rgba(255,107,0,.1);
      border: 1px solid var(--orange);
      border-radius: 9px;
      font-size: .78rem; color: var(--orange);
      display: none;
    }

    @media (max-width: 480px) {
      #ai-widget { bottom: 16px; right: 16px; }
      #ai-chatbox { width: calc(100vw - 32px); }
    }
  </style>
</head>
<body>

  <div id="overlay"></div>

  <header>
    <button id="btn-menu" aria-label="M·ªü menu">
      <span></span><span></span><span></span>
    </button>
    <div id="logo">Study Helper</div>
    <div id="active-badge">L√Ω thuy·∫øt</div>
  </header>

  <aside id="sidebar" role="navigation" aria-label="ƒêi·ªÅu h∆∞·ªõng ch√≠nh">
    <div class="sidebar-header">üìö Menu</div>
    <nav id="sidebar-nav">
      <!-- [S·ª¨A] data-src tr·ªè ƒë√∫ng ƒë∆∞·ªùng d·∫´n file th·ª±c -->
      <a data-page="theory" data-src="../Theory/theory.html" class="active">
        <span class="nav-icon">üìñ</span> L√Ω thuy·∫øt
      </a>
      <a data-page="practice" data-src="../Practice/practice.html">
        <span class="nav-icon">‚úèÔ∏è</span> Luy·ªán t·∫≠p
      </a>
      <div class="nav-divider"></div>
      <a data-page="instruct" data-src="../Instruct/instruct.html">
        <span class="nav-icon">‚ùì</span> H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng
      </a>
    </nav>
    <div class="sidebar-footer">
      <button id="btn-theme" aria-label="Chuy·ªÉn ch·∫ø ƒë·ªô s√°ng/t·ªëi">
        <span id="theme-label">üåô Ch·∫ø ƒë·ªô t·ªëi</span>
        <div class="toggle-track"><div class="toggle-thumb"></div></div>
      </button>
    </div>
  </aside>

  <main id="main">
    <!-- [S·ª¨A] D√πng iframe thay v√¨ inject template -->
    <!-- Iframe load module th·ª±c: Theory, Practice, Instruct -->
    <iframe id="module-frame"
            src="../Theory/theory.html"
            title="N·ªôi dung module"
            allow="same-origin">
    </iframe>
    <div id="frame-error">
      Kh√¥ng th·ªÉ t·∫£i module. H√£y m·ªü b·∫±ng local server (Live Server / http-server).
    </div>
  </main>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       AI CHAT WIDGET
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="ai-widget">
    <!-- C·ª≠a s·ªï chat (·∫©n m·∫∑c ƒë·ªãnh) -->
    <div id="ai-chatbox" class="hidden">
      <div id="ai-chat-header">
        <img src="icon.jpg" alt="AI" onerror="this.style.display='none'">
        <div class="ai-header-info">
          <div class="ai-name">‚ú® Tr·ª£ l√Ω Study Helper</div>
          <div class="ai-status-text">ƒêang ho·∫°t ƒë·ªông</div>
        </div>
        <button id="ai-btn-close" title="ƒê√≥ng">‚úï</button>
      </div>

      <div id="ai-api-warn">
        ‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh API key trong <code>home.json</code>. AI s·∫Ω kh√¥ng ho·∫°t ƒë·ªông.
      </div>

      <div id="ai-messages"></div>

      <div id="ai-input-area">
        <textarea id="ai-input" rows="1" placeholder="H·ªèi b·∫•t c·ª© ƒëi·ªÅu g√¨ v·ªÅ b√†i h·ªçc..."></textarea>
        <button id="ai-send" title="G·ª≠i">‚û§</button>
      </div>
    </div>

    <!-- N√∫t toggle -->
    <div id="ai-toggle-wrap">
      <button id="ai-toggle" title="Tr·ª£ l√Ω AI">
        <img src="icon.jpg" alt="AI" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 40 40%22><circle cx=%2220%22 cy=%2220%22 r=%2220%22 fill=%22%2300CED1%22/><text x=%2250%%25%22 y=%2255%%25%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 font-size=%2222%22>ü§ñ</text></svg>'">
      </button>
      <div class="ai-status"></div>
    </div>
  </div>

  <script>
    /* ============================================================
       home.js ‚Äì Study Helper
       [S·ª¨A CH√çNH] Chuy·ªÉn t·ª´ inject template sang ƒëi·ªÅu h∆∞·ªõng iframe th·ª±c
    ============================================================ */
    (() => {
      'use strict';

      const body      = document.body;
      const btnMenu   = document.getElementById('btn-menu');
      const overlay   = document.getElementById('overlay');
      const navLinks  = document.querySelectorAll('#sidebar-nav a[data-page]');
      const frame     = document.getElementById('module-frame');
      const btnTheme  = document.getElementById('btn-theme');
      const themeLabel= document.getElementById('theme-label');
      const badge     = document.getElementById('active-badge');

      /* Metadata m·ªói trang */
      const PAGE_META = {
        theory  : { label: 'L√Ω thuy·∫øt',         src: '../Theory/theory.html'    },
        practice: { label: 'Luy·ªán t·∫≠p',          src: '../Practice/practice.html'},
        instruct: { label: 'H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng', src: '../Instruct/instruct.html'}
      };

      /* ‚îÄ‚îÄ CHATBOT ‚îÄ‚îÄ */
      const aiWidget = document.getElementById('ai-widget');
      function updateAIVisibility(url) {
        // Ch·ªâ hi·ªán AI khi v√†o L√Ω thuy·∫øt
        if (url.includes('Theory')) {
          aiWidget.style.display = 'flex';
        } else {
          aiWidget.style.display = 'none';
        }
      }

      /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
      function openSidebar()  { body.classList.add('sidebar-open'); }
      function closeSidebar() { body.classList.remove('sidebar-open'); }

      btnMenu.addEventListener('click', () => body.classList.toggle('sidebar-open'));
      overlay.addEventListener('click', closeSidebar);
      document.addEventListener('keydown', e => { if (e.key === 'Escape') closeSidebar(); });

      /* ‚îÄ‚îÄ NAVIGATE (iframe src swap, kh√¥ng reload trang ch·ªß) ‚îÄ‚îÄ */
      function loadPage(pageId, customUrl) {
        const meta = PAGE_META[pageId];
        if (!meta) return;

        /* C·∫≠p nh·∫≠t iframe src ‚Äî d√πng customUrl n·∫øu c√≥ (v√≠ d·ª• t·ª´ Theory sang Practice v·ªõi params) */
        frame.src = customUrl || meta.src;
        updateAIVisibility(customUrl || meta.src);

        /* Active link */
        navLinks.forEach(a => a.classList.toggle('active', a.dataset.page === pageId));

        /* Badge */
        badge.textContent = meta.label;

        /* L∆∞u tr·∫°ng th√°i */
        localStorage.setItem('sh-active-page', pageId);
        history.replaceState({ page: pageId }, '', `#${pageId}`);

        closeSidebar();
      }

      navLinks.forEach(a => {
        a.addEventListener('click', e => {
          e.preventDefault();
          loadPage(a.dataset.page);
        });
      });

      /* ‚îÄ‚îÄ DARK / LIGHT ‚îÄ‚îÄ */
      function applyTheme(dark) {
        body.classList.toggle('dark', dark);
        themeLabel.textContent = dark ? '‚òÄÔ∏è Ch·∫ø ƒë·ªô s√°ng' : 'üåô Ch·∫ø ƒë·ªô t·ªëi';
        localStorage.setItem('sh-theme', dark ? 'dark' : 'light');
        /* [S·ª¨A] Truy·ªÅn theme v√†o iframe qua postMessage */
        try {
          frame.contentWindow.postMessage({ type: 'SH_THEME', dark }, '*');
        } catch(_) {}
      }

      btnTheme.addEventListener('click', () => applyTheme(!body.classList.contains('dark')));

      /* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
      function init() {
        /* Theme */
        const saved = localStorage.getItem('sh-theme');
        if (saved === 'dark') applyTheme(true);
        else if (!saved) applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches);

        /* [S·ª¨A] ƒê·ªçc page t·ª´ hash ho·∫∑c localStorage */
        const hash   = location.hash.replace('#', '');
        const stored = localStorage.getItem('sh-active-page');
        const start  = PAGE_META[hash] ? hash : (PAGE_META[stored] ? stored : 'theory');
        loadPage(start);
      }

      /* [S·ª¨A] L·∫Øng nghe message t·ª´ iframe ƒë·ªÉ ƒëi·ªÅu h∆∞·ªõng t·ª´ b√™n trong module */
      window.addEventListener('message', e => {
        if (!e.data || e.data.type !== 'SH_NAVIGATE') return;
        const { page, url } = e.data;
        if (PAGE_META[page]) loadPage(page, url || null);
      });

      /* [S·ª¨A] L·∫Øng nghe load t·ª´ iframe ƒë·ªÉ ·∫©n hi·ªán chatbot */
      frame.addEventListener('load', () => {
      try {
        const currentURL = frame.contentWindow.location.pathname;
        updateAIVisibility(currentURL);
      } catch (_) {
        // cross-origin safety (kh√¥ng sao)
      }
    });

      init();
    })();

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       AI CHAT WIDGET
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    (() => {
      'use strict';

      const widget   = document.getElementById('ai-widget');
      const chatbox  = document.getElementById('ai-chatbox');
      const toggle   = document.getElementById('ai-toggle');
      const btnClose = document.getElementById('ai-btn-close');
      const messages = document.getElementById('ai-messages');
      const input    = document.getElementById('ai-input');
      const sendBtn  = document.getElementById('ai-send');
      const apiWarn  = document.getElementById('ai-api-warn');

      let cfg        = null;   // home.json config
      let history    = [];     // conversation history g·ª≠i l√™n API
      let isOpen     = false;
      let isLoading  = false;
      let welcomed   = false;

      /* ‚îÄ‚îÄ Load config t·ª´ home.json ‚îÄ‚îÄ */
      async function loadConfig() {
        try {
          const res = await fetch('home.json');
          if (!res.ok) throw new Error();
          cfg = await res.json();
          /* Ki·ªÉm tra API key */
          if (!cfg.ai_api_key || cfg.ai_api_key === 'YOUR_ANTHROPIC_API_KEY_HERE') {
            apiWarn.style.display = 'block';
          }
          /* C·∫≠p nh·∫≠t placeholder n·∫øu c√≥ */
          if (cfg.ai_placeholder) input.placeholder = cfg.ai_placeholder;
        } catch(_) {
          apiWarn.style.display = 'block';
          apiWarn.textContent = '‚ö†Ô∏è Kh√¥ng t·∫£i ƒë∆∞·ª£c home.json. Ki·ªÉm tra file c·∫•u h√¨nh.';
        }
      }

      /* ‚îÄ‚îÄ M·ªü / ƒê√≥ng chat ‚îÄ‚îÄ */
      function openChat() {
        isOpen = true;
        widget.classList.add('open');
        chatbox.classList.remove('hidden');
        toggle.style.borderColor = 'var(--orange)';
        /* Hi·ªán tin nh·∫Øn ch√†o l·∫ßn ƒë·∫ßu */
        if (!welcomed && cfg?.ai_welcome) {
          welcomed = true;
          addMessage('bot', cfg.ai_welcome);
        }
        setTimeout(() => input.focus(), 250);
      }

      function closeChat() {
        isOpen = false;
        widget.classList.remove('open');
        chatbox.classList.add('hidden');
        toggle.style.borderColor = 'var(--cyan)';
      }

      toggle.addEventListener('click', () => isOpen ? closeChat() : openChat());
      btnClose.addEventListener('click', closeChat);

      /* ‚îÄ‚îÄ Render message ‚îÄ‚îÄ */
      function addMessage(role, text) {
        const div = document.createElement('div');
        div.className = `ai-msg ${role}`;
        /* Chuy·ªÉn newline th√†nh <br> v√† escape HTML c∆° b·∫£n */
        const safe = text
          .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
          .replace(/\n/g,'<br>');
        div.innerHTML = `<div class="ai-bubble">${safe}</div>`;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
        return div;
      }

      function addTyping() {
        const div = document.createElement('div');
        div.className = 'ai-msg bot ai-typing';
        div.innerHTML = `<div class="ai-bubble"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
        return div;
      }

      /* ‚îÄ‚îÄ G·ª≠i tin nh·∫Øn ‚îÄ‚îÄ */
      async function sendMessage() {
        const text = input.value.trim();
        if (!text || isLoading) return;
        if (!cfg?.ai_api_key || cfg.ai_api_key === 'YOUR_ANTHROPIC_API_KEY_HERE') {
          addMessage('bot', '‚ö†Ô∏è B·∫°n c·∫ßn c·∫•u h√¨nh API key trong file home.json tr∆∞·ªõc khi d√πng AI.');
          return;
        }

        /* Hi·ªÉn th·ªã tin c·ªßa user */
        addMessage('user', text);
        history.push({ role: 'user', content: text });
        input.value = '';
        input.style.height = '';
        sendBtn.disabled = true;
        isLoading = true;

        /* Hi·ªán typing indicator */
        const typingEl = addTyping();

        try {
          const res = await fetch(`https://generativelanguage.googleapis.com/v1/${cfg.ai_model}:generateContent?key=${cfg.ai_api_key}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },

            body: JSON.stringify({
              contents: [
                {
                  role: "user",
                  parts: [
                    {
                      text: (cfg.ai_system_prompt || "B·∫°n l√† tr·ª£ l√Ω h·ªçc t·∫≠p cho h·ªçc sinh THPT. Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát.") + "\n\n" + text
                    }
                  ]
                }
              ]
            })
          }
        );

          const data = await res.json();
          typingEl.remove();

          if (!res.ok) {
            const errMsg = data?.error?.message || `L·ªói ${res.status}`;
            addMessage('bot', `‚ùå L·ªói API: ${errMsg}`);
            history.pop(); /* X√≥a tin l·ªói kh·ªèi history */
          } else {
            const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || '(Kh√¥ng c√≥ ph·∫£n h·ªìi)';
            addMessage('bot', reply);
            history.push({ role: 'assistant', content: reply });
            /* Gi·ªõi h·∫°n history 20 l∆∞·ª£t ƒë·ªÉ tr√°nh token overflow */
            if (history.length > 40) history = history.slice(-40);
          }
        } catch(err) {
          typingEl.remove();
          addMessage('bot', `‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi API. Ki·ªÉm tra m·∫°ng ho·∫∑c API key.\n${err.message}`);
          history.pop();
        }

        sendBtn.disabled = false;
        isLoading = false;
        input.focus();
      }

      /* ‚îÄ‚îÄ G·ª≠i khi b·∫•m n√∫t ho·∫∑c Enter (kh√¥ng Shift) ‚îÄ‚îÄ */
      sendBtn.addEventListener('click', sendMessage);
      input.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      /* ‚îÄ‚îÄ Auto-resize textarea ‚îÄ‚îÄ */
      input.addEventListener('input', () => {
        input.style.height = '';
        input.style.height = Math.min(input.scrollHeight, 100) + 'px';
        sendBtn.disabled = !input.value.trim();
      });

      /* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
      sendBtn.disabled = true;
      loadConfig();
    })();
  </script>
</body>
</html>
